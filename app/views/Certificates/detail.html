#{extends 'templates/main.html' /}
#{set pageTitle: 'Certificate Management' /}
#{set readOnly: ((mode != 'edit' && mode != 'entry') || confirming ) /}
#{set id:certificate?.certificateKey /}
#{set mode: mode /}
#{script 'date.js', characterset:'utf-8' /}
#{script 'lookups.js' /}
#{script 'lookuppaging.js' /}
#{script 'date.format.js' /}
#{script 'external/Util.js' /}
<script type="text/javascript">
#{include 'RegistrySubscription/Util.js' /}
	$(function() {
		$('#tabDetailCertificate').tabs();
		if (('${mode}'=='entry') || (('${mode}'=='edit') && (('${certificate?.recordStatus?.decodeStatus()}' == 'Reject') || ($("#status").val() == 'R' )))) {
			$('input[name=isActive]').attr("disabled", "disabled");
			$('input[name=certificate.inactiveDate]').attr("disabled", "disabled");
			$('p[id=inactiveDateId] label span').html(' ');
		}else{
			if ($("input[name='certificate.isActive']").val() == 'false') {
				$('p[id=inactiveDateId] label span').html(' *');
			}else {
				$('p[id=inactiveDateId] label span').html(' ');
			}
			
			if ('${mode}'=='edit') {
				if ($("input[name='certificate.isActive']").val() != 'false') {
					$('input[name=certificate.inactiveDate]').attr("disabled", "disabled");
				}
			}
		}
	//	$('#certificateQuantity').autoNumeric({vMin: '1'});
		
		if (jQuery.trim($("#tabCertificate").val()) == ""){
// 			$("#tabDetailCertificate").tabs("disable",0);
// 			$("#tabDetailCertificate").tabs("disable",1);
			$("#tabDetailCertificate").tabs("enable",0);
			$("#tabDetailCertificate").tabs("select",0);
// 			$("#tabDetailCertificate").tabs("disable",1);
		}else if (jQuery.trim($("#tabCertificate").val()) == "0"){
			$("#tabDetailCertificate").tabs("enable",0);
			$("#tabDetailCertificate").tabs("select",0);
// 			$("#tabDetailCertificate").tabs("disable",1);
		}else if (jQuery.trim($("#tabCertificate").val()) == "1"){
// 			$("#tabDetailCertificate").tabs("enable",1);
// 			$("#tabDetailCertificate").tabs("select",1);
// 			$("#tabDetailCertificate").tabs("disable",0);
			$("#tabDetailCertificate").tabs("enable",0);
			$("#tabDetailCertificate").tabs("select",0);
// 			$("#tabDetailCertificate").tabs("disable",1);
			
			if ($('#depositoNo').val() == '') {
				clearDeposito();
			}
		}
		
		
			
		$("input[name='isActive']").change(function() {
			$("input[name='certificate.isActive']").val($("input[name='isActive']:checked").val());
			if ($("input[name='certificate.isActive']").val() == 'false') {
				$('p[id=inactiveDateId] label span').html(' *');
				$('input[name=certificate.inactiveDate]').attr("disabled", "");
			}else {
				$('p[id=inactiveDateId] label span').html(' ');
				//disabled inactive date dan kosongin nilainya
				$('#inactiveDate').val('');
				$('input[name=certificate.inactiveDate]').attr("disabled", "disabled");
				$('p[id=inactiveDateId] label span').html(' ');
				$('inactiveDate').removeClass('fieldError');
				$("#CertificateForm").find("span[id='inactiveDateError']").html("");
			}
		});
		
		$('#filterDeposito').val($('#accountKey').val()+"-"+$('#securityKey').val());
		
		if ('${taskId}'!="") {
			$("#cancel").button().hide();
		}
	
		if (jQuery.trim($('#depositoStatusHidden').val())=='A'){
			$('#depositoStatus').val("Approved");
		}
		
		var data = new Object();
		tabCertificateTrans(data);
		$('.calendar').datepicker();
		$( "#detailForCertificateTransDetails" ).dialog({
			autoOpen:false,
			modal:true,
			heigth:'800px',
			width:'600px',
			resizable:false
		});
		$('#save, #confirmData, #back, #cancel, #newCertificateTransDetail, #cancelCertificateTransDetail, #addCertificateTransDetail, #cancelCertificateTransDetail').button();
		
		$('#newCertificateTransDetail').click(function() {
				selectedRow = null;
				$("#detailForCertificateTransDetails").dialog('open');
				$('.ui-widget-overlay').css('height',$('body').height());
				$("#detailForCertificateTransDetails input:text").val(""); 
				$("#detailForCertificateTransDetails input:hidden").val(""); 
				//$("#detailForManualJournalDetails #position").val(""); 
				//$("#detailForCertificateTransDetails #detailCertificateTransForm .errmsg").html("");
				$('#detailForCertificateTransDetails #detailCertificateTransForm  #filter').val($('#CertificateForm  #accountKey').val()+"-"+$('#CertificateForm  #securityKey').val());
				//$('#detailForCertificateTransDetails #detailCertificateTransForm  #filter').val($('#CertificateForm #Certificate #securityKey').val());
				transactionNo($('#detailForCertificateTransDetails #detailCertificateTransForm  #filter').val());
				
				$("#detailForCertificateTransDetails #detailCertificateTransForm").find("span[id*='Error']").html("");
				$("#detailForCertificateTransDetails #detailCertificateTransForm #transactionNo").removeClass('fieldError');
			return false;
		
		});
		
		
		if ($('#portModeCode').val() == "") {
			$('#portModeCode').val('${portMoveSKP.lookupCode}');
			$('#portMode').val('${portMoveSKP.lookupId}');
			$('#portModeDesc').val('${portMoveSKP.lookupDescription}');
			$('#h_portModeDesc').val('${portMoveSKP.lookupDescription}');
		}
		
		$('#portModeCode').lookup({
			list:'@{Pick.lookups()}?group=PORT_MOVE',
			get:{
				url:'@{Pick.lookup()}?group=PORT_MOVE',
				success: function(data){
					$('#portModeCode').removeClass('fieldError');
					$('#portMode').val(data.code);
					$('#portModeDesc').val(data.description);
					$('#h_portModeDesc').val(data.description);
				},
				error: function(data){
					$('#portModeCode').addClass('fieldError');
					$('#portMode').val('');
					$('#portModeCode').val('');
					$('#portModeDesc').val('NOT FOUND');
					$('#h_portModeDesc').val('');
				}
			},
			//key:$('#portMode'),
			description:$('#portModeDesc'),
			help:$('#portModeHelp')
		});
		
		var securityKeyFiter = "";
		if ($("#securityKey").val() != ""){
			securityKeyFiter = $("#securityKey");
		}
		
		accountNo(securityKeyFiter);
		
		function accountNo(data){
			//key sengaja id nya di bikin beda agar bisa tahu nilai old nya
			$('#accountNo').dynapopup2({key:'accountKeys', help:'accountHelp', desc:'accountName'}, 'PICK_CS_ACCOUNT', '', 'securityType', function(sdata){
				var data = $().fetchSync("@{Pick.accountGetCurrentHolding()}", {'code':$('#accountNo').val(), 'filter':$('#securityKey').val()});
				if(data){
					var accountKey = $('#accountKey').val();
// 					if(accountKey != data.code){
// 						tableCertificateTransDetail.fnClearTable();
// 					}
					$('#accountNo').removeClass('fieldError');
					$('#accountName').val(data.description);
					$('#h_accountName').val(data.description);
					$('#accountKey').val(data.code);
					$('#currentHolding').val($('#dummy').myAutoNumericGet(data.currentHolding));
					$('#currentHoldingStripped').val(data.currentHolding);
					$('#filterDeposito').val($('#accountKey').val()+"-"+$('#securityKey').val());
				}
				$('#accountNo').trigger("refreshDepositoPopup");
				clearDeposito();
			},function(data){
				$('#accountNo').addClass('fieldError');
				$('#accountName').val('NOT FOUND');
				$('#accountNo').val('');
				
				$('#h_accountName').val('');
				$('#accountKey').val('');
				$('#currentHolding').val('');
				$('#currentHoldingStripped').val('');
				$('#filterDeposito').val('');
				$('#accountNo').trigger("refreshDepositoPopup");
				clearDeposito();
			});

			
		}
		
			$('#accountNo').blur(function() {
			
				if (($('#accountNo').val() == "")) {
					clearDeposito();
// 					tableCertificateTransDetail.fnClearTable();
					/* if ($('#accountNo').val() == "") {
						$('#accountNo').val("");
						$('#accountKey').val("");
						$('#accountName').val("");
						$('#h_accountName').val("");
					} */
				}
			});
			
		$('#addCertificateTransDetail').die("click");
		$('#addCertificateTransDetail').live("click", function() {
			setTimeout(function() {
				var table = $('#gridCertificateTrans').dataTable();
				var transactionNo = $("#detailForCertificateTransDetails #detailCertificateTransForm #transactionNo").val();
				var rowPosition = $("#detailForCertificateTransDetails #detailCertificateTransForm #rowPosition").val();
				$("#detailForCertificateTransDetails #detailCertificateTransForm #transactionHelp").focus();
				//saveManualJournalDetail();
				
				//function saveManualJournalDetail(){
					if (($("#detailForCertificateTransDetails #detailCertificateTransForm #transactionNo").val() == "")) {
						$("#detailForCertificateTransDetails #detailCertificateTransForm").find("span[id*='Error']").html("");
						
						$("#detailForCertificateTransDetails #detailCertificateTransForm #transactionNoError").html('Required').show();
					} else {
						var dataCertificateDetail = table.fnGetData(parseFloat(rowPosition));
						if (rowPosition != "") {
							var found = false;
							var oldTransactionKey = $('#detailForCertificateTransDetails #detailCertificateTransForm  #oldTransactionKey').val();
							var newTransactionKey = $('#detailForCertificateTransDetails #detailCertificateTransForm  #newTransactionKey').val();
							// CHECKED DUPLICATE ROW
							var rows = table.fnGetNodes().length;
							for (i = 0; i < rows; i++) {
								var cells = table.fnGetData(i);
									if ((transactionNo == cells.transactionNumber) && (oldTransactionKey != newTransactionKey)) {
										$('#detailForCertificateTransDetails #detailCertificateTransForm #transactionNoError').html('<b> already Exist!</b>');
										found = true;
										break;
									}
							} 
							if (!found) {
								
									table.fnUpdate(dataCertificateDetail.transactionNumber =  $("#detailForCertificateTransDetails #detailCertificateTransForm #transactionNo").val() ,parseFloat(rowPosition),0);
									table.fnUpdate(dataCertificateDetail.holdingRefs = $("#detailForCertificateTransDetails #detailCertificateTransForm #holdingRefs").val(),parseFloat(rowPosition),1);
									table.fnUpdate(dataCertificateDetail.description = $("#detailForCertificateTransDetails #detailCertificateTransForm #description").val(),parseFloat(rowPosition),2);
									table.fnUpdate(dataCertificateDetail.quantity = $("#detailForCertificateTransDetails #detailCertificateTransForm #quantityStripped").val(),parseFloat(rowPosition),3);
									table.fnUpdate(dataCertificateDetail.transactionStatus = $("#detailForCertificateTransDetails #detailCertificateTransForm #transactionStatus").val(),parseFloat(rowPosition),4);
						
									dataCertificateDetail.account.accountNo = $("#detailForCertificateTransDetails #detailCertificateTransForm #accountNo").val();
									dataCertificateDetail.account.custodyAccountKey = $("#detailForCertificateTransDetails #detailCertificateTransForm #accountKey").val();
									dataCertificateDetail.account.name = $("#detailForCertificateTransDetails #detailCertificateTransForm #accountName").val();
									dataCertificateDetail.transactionStatus = $("#detailForCertificateTransDetails #detailCertificateTransForm #transactionStatus").val();
									dataCertificateDetail.security.securityKey = $("#detailForCertificateTransDetails #detailCertificateTransForm #securityKey").val();
									dataCertificateDetail.security.securityId = $("#detailForCertificateTransDetails #detailCertificateTransForm #securityCode").val();
									dataCertificateDetail.security.securityType.securityType = $("#detailForCertificateTransDetails #detailCertificateTransForm #securityType").val();
									dataCertificateDetail.settlementDate = $("#detailForCertificateTransDetails #detailCertificateTransForm #settlementDate").val();
									dataCertificateDetail.transactionTemplate.transactionCode = $("#detailForCertificateTransDetails #detailCertificateTransForm #transactionCode").val();
									dataCertificateDetail.transactionTemplate.description = $("#detailForCertificateTransDetails #detailCertificateTransForm #transactionDescription").val();
									dataCertificateDetail.transactionTemplate.transactionTemplateKey = $("#detailForCertificateTransDetails #detailCertificateTransForm #transactionTemplateKey").val();
									dataCertificateDetail.amount = $("#detailForCertificateTransDetails #detailCertificateTransForm #amountStripped").val();
									dataCertificateDetail.settlementAmount = $("#detailForCertificateTransDetails #detailCertificateTransForm #settlementAmountStripped").val();
									dataCertificateDetail.price = $("#detailForCertificateTransDetails #detailCertificateTransForm #priceStripped").val();
									dataCertificateDetail.transactionKey =  $("#detailForCertificateTransDetails #detailCertificateTransForm #transactionKey").val()
									table.fnUpdate(dataCertificateDetail,parseFloat(rowPosition),5);
									
									$('#detailForCertificateTransDetails').dialog('close');
							}
						} else {
							var found = false;
							// CHECKED DUPLICATE ROW
							var rows = table.fnGetNodes().length;
							for (i = 0; i < rows; i++) {
								var cells = table.fnGetData(i);
									if ((transactionNo == cells.transactionNumber)) {
										$('#detailForCertificateTransDetails #detailCertificateTransForm #transactionNoError').html('<b> already Exist!</b>');
										found = true;
										break;
									}	
							} 
							if (!found) {
									var dataCertificateDetail = new Object();
									dataCertificateDetail.account = new Object();
									dataCertificateDetail.security = new Object();
									dataCertificateDetail.transactionTemplate = new Object();
									dataCertificateDetail.security.securityType = new Object();
									dataCertificateDetail.transactionNumber = $("#detailForCertificateTransDetails #detailCertificateTransForm #transactionNo").val();
									dataCertificateDetail.transactionKey = $("#detailForCertificateTransDetails #detailCertificateTransForm #transactionKey").val();
									dataCertificateDetail.holdingRefs= $('#detailForCertificateTransDetails #detailCertificateTransForm #holdingRefs').val();
									dataCertificateDetail.transactionStatus = $("#detailForCertificateTransDetails #detailCertificateTransForm #transactionStatus").val();
									dataCertificateDetail.description =  $("#detailForCertificateTransDetails #detailCertificateTransForm #description").val();
									dataCertificateDetail.transactionDate = $("#detailForCertificateTransDetails #detailCertificateTransForm #transactionDate").val();
									
									dataCertificateDetail.account.accountNo = $("#detailForCertificateTransDetails #detailCertificateTransForm #accountNo").val();
									dataCertificateDetail.account.custodyAccountKey = $("#detailForCertificateTransDetails #detailCertificateTransForm #accountKey").val();
									dataCertificateDetail.account.name = $("#detailForCertificateTransDetails #detailCertificateTransForm #accountName").val();
									dataCertificateDetail.transactionTemplate.transactionCode = $("#detailForCertificateTransDetails #detailCertificateTransForm #transactionCode").val();
									dataCertificateDetail.transactionTemplate.transactionTemplateKey = $("#detailForCertificateTransDetails #detailCertificateTransForm #transactionTemplateKey").val();
									dataCertificateDetail.transactionTemplate.description = $("#detailForCertificateTransDetails #detailCertificateTransForm #transactionDescription").val();
									dataCertificateDetail.security.securityKey = $("#detailForCertificateTransDetails #detailCertificateTransForm #securityKey").val();
									dataCertificateDetail.security.securityId = $("#detailForCertificateTransDetails #detailCertificateTransForm #securityCode").val();
									dataCertificateDetail.security.description = $("#detailForCertificateTransDetails #detailCertificateTransForm #securityDesc").val();
									dataCertificateDetail.security.securityType.securityType = $("#detailForCertificateTransDetails #detailCertificateTransForm #securityType").val();
									dataCertificateDetail.settlementDate = $("#detailForCertificateTransDetails #detailCertificateTransForm #settlementDate").val();
									dataCertificateDetail.quantity = $("#detailForCertificateTransDetails #detailCertificateTransForm #quantityStripped").val();
									dataCertificateDetail.price = $("#detailForCertificateTransDetails #detailCertificateTransForm #priceStripped").val();
									dataCertificateDetail.amount = $("#detailForCertificateTransDetails #detailCertificateTransForm #amountStripped").val();
									dataCertificateDetail.settlementAmount = $("#detailForCertificateTransDetails #detailCertificateTransForm #settlementAmountStripped").val();
									table.fnAddData(dataCertificateDetail);
									$('#detailForCertificateTransDetails').dialog('close');
							}
						}
						return false;		
					}
				//}
				}, 500);
		});
		
		$('#gridCertificateTrans tbody tr #deleteButton').live('click', function() {
			var row = $(this).parents('tr');
			var rowNumber = tableCertificateTransDetail.fnGetPosition(row[0]);
			var deleteCertificateTransDetail = function(){
				tableCertificateTransDetail.fnDeleteRow(rowNumber);
				reordering();
				$("#dialog-message").dialog("close");
				
				return false;
			}
			messageAlertYesNo("Are you sure to delete data ?", "ui-icon ui-icon-notice", "Confirmation Message", deleteCertificateTransDetail, closeDialogMessage);
		});
		
		$('#cancel').click(function(){
			if (('${mode}' == 'view') && ('${param}' != 'dedupe') && ('${param}' != 'edit')) {
				location.href='@{list()}?mode=view';
			} else if (('${mode}' == 'edit') || ('${param}' == 'edit')) {
				location.href='@{list()}?mode=edit&param=edit';
			} else {
				location.href='@{dedupe()}';
			}
			return false;
		});
		
		// enable file upload
		//$( "#form.form" ).attr("enctype", "multipart/form-data");
		
		$('#denomination').blur(function(){
			if ($('#nominalStripped').val() ==  $('#denominationStripped').val()) {
				$("#CertificateForm").find("span[id='denominationError']").html("");
			}
		});
		
		$('#inactiveDate').blur(function(){
			if ($(this).val() == "") {
				if ($("input[name='certificate.isActive']").val() == 'false'){
					$("#CertificateForm").find("span[id='inactiveDateError']").html("Required");
					$('#inactiveDate').addClass('fieldError');
				}else {
					$('#inactiveDate').removeClass('fieldError');
					$("#CertificateForm").find("span[id='inactiveDateError']").html("");
				}
			}
			
		});
		
		function doSave(){
			if ($('#certificateId').hasClass('fieldError')){
				$('#certificateId').focus();
				return false;
			}
			
			if ($('#nominalStripped').val() !=  $('#denominationStripped').val()) {

				$("#CertificateForm").find("span[id='denominationError']").html("denomination is not equal with nominal");
				return false;
			}else {
				$("#CertificateForm").find("span[id='denominationError']").html("");
			}
			
			if (($('#inactiveDate').val() == "") && ($("input[name='certificate.isActive']").val() == 'false')) {
				if (('${mode}'=='entry') || (('${mode}'=='edit') && (('${certificate?.recordStatus?.decodeStatus()}' == 'Reject') || ($("#status").val() == 'R' )))) {
					return true;
				}else{
					$('#inactiveDate').focus();
					return false;
				}
			}
			return true;
		};
		
		$('#save').click(function() {
			var resume = true;
			
			if (typeof doSave == 'function') {
				resume = doSave();
			}
			if (resume) {
				
					var action = "@{save()}?mode=${mode}#{if group}&group=${group}#{/}";
					/* var loading = $('<div id="loading" class="loading"><img src="@@{'/public/images/loading2.gif'}" style="margin:10px" align="middle" /> Saving...</div>').appendTo('body');
					loading.dialog({
						closeOnEscape: false,
						draggable: false,
						modal: true,
						resizable: false,
						open:function() {
							$(this).parents(".ui-dialog:first").find(".ui-dialog-titlebar-close").remove();
						} 
					}); */
					loading.dialog('open');
					/* if($.browser.msie){
						$("#CertificateForm.form").attr("enctype", "multipart/form-data");
						$('#CertificateForm.form').attr('action', action);
						$('#CertificateForm.form').submit();
					} else { */
						$("#CertificateForm").attr("enctype", "multipart/form-data");
						$('#CertificateForm').attr('action', action);
						$('#CertificateForm').submit();
					//}
				
			}
			return false;
		});
		
		
		
		var closeDialogMessage = function() {
			$("#dialog-message").dialog("close");
		}
		
		var backToList = function() {
			loading.dialog('open');
			location = "@{list()}";
		}
		
		var backToEntry = function() {
			loading.dialog('open');
			location = "@{entry()}";
		}
		
		$('#confirmData').click(function(){
			var action = "@{confirm()}?mode=${mode}#{if group}&group=${group}#{/}#{if param}&param=${param}#{/}";
			loading.dialog('open');
			$.post(action, $('#CertificateForm').serialize(), function(data, status, xhr) {
// 	    		checkRedirect(data);
				loading.dialog('close');
				if (data.status == 'success') {
					if ('${mode}'=='entry') {
						messageAlertOk(data.message, "ui-icon ui-icon-circle-check", "Notification", backToList);
						return false;
					}
					if ('${mode}'=='edit') {
						messageAlertOk(data.message, "ui-icon ui-icon-circle-check", "Notification", backToList);
						return false;
					}
					
				} else {
					//messageAlertOk(data.error, "ui-icon1 ui-icon-circle-close", "Error Message", closeDialogMessage);
					$("#dialog-message").dialog("close");
					loading.dialog('open');
					$('#CertificateForm').attr('action', action);
					$('#CertificateForm').submit();
					return false;
				}
			});
		});

		/* $('#confirm').click(function(){
		var resume = true;
		if (typeof doConfirm == 'function') { 
			resume = doConfirm();
		}
		if (resume) {
			var action = "@{confirm()}?mode=${mode}#{if group}&group=${group}#{/}#{if param}&param=${param}#{/}";
			/* var loading = $('<div id="loading" class="loading"><img src="@@{'/public/images/loading2.gif'}" style="margin:10px" align="middle" /> Saving...</div>').appendTo('body');
			loading.dialog({
				closeOnEscape: false,
				draggable: false,
				modal: true,
				resizable: false,
				open:function() {
					$(this).parents(".ui-dialog:first").find(".ui-dialog-titlebar-close").remove();
				} 
			}); */
		/*	loading.dialog('open');
			$('#CertificateForm').attr('action', action);
			$('#CertificateForm').submit();
		}
		return false;
	}); */
		
		$('#back').click(function() {
			var resume = true;
			if (typeof doBack == 'function') { 
				resume = doBack();
			}
			if (resume) location.href='@{back(id)}?mode=${mode}#{if status}&status=${status}#{/}#{if group}&group=${group}#{/}#{if param}&param=${param}#{/}#{if from}&from=${from}#{/}';
			return false;
		});
		
		$('#depositoNo').change(function() {
			$("#depositoNoError").html('').show();
			if ($('#depositoNo').val() == '') {
				clearDeposito();
			}
		});
		
		function ifEmptyThenZero(param)  {
			if (param == "") return "0";
			return param;
		}
		
		$("#accountNo").add($("#securityCode")).bind("refreshDepositoPopup", function(){
			attachDepositoNo();
		});
		
		function attachDepositoNo() {
			//alert($('#accountKey').val()+"   "+$('#securityKey').val());
			var accountKey = $('#accountKey').val() == "" ? "0" : $('#accountKey').val();
			var securityKey = $('#securityKey').val() == "" ? "0" : $('#securityKey').val();
			var depositoKey = $('#depositoKey').val() == "" ? "0" : $('#depositoKey').val();
			
			$('#depositoNo').dynapopup2({key:'depositoKey', help:'depositoHelp'}, 'PICK_TD_MASTER', accountKey +"|"+ securityKey+"|"+depositoKey, 'save', function(sdata){
				var data = $().fetchSync("@{Pick.tdMasterPick()}", {'code':$('#depositoNo').val(), 'account':accountKey, 'security':securityKey});
				if (data){
					var depositoKey = $('#depositoKey').val();
// 					if(depositoKey != data.depositoKey){
// 						tableCertificateTransDetail.fnClearTable();
// 					}
					$('#securityType').removeClass('fieldError');
					$('#depositoNo').val(data.depositoNo);
					$('#depositoKey').val(data.depositoKey);
					$('#amount').val(data.amount);
					$('#amountStripped').val(data.amount);
					$('#placementDate').val(data.placementDate);
					if (jQuery.trim(data.depositoStatus)=='A'){
						$('#depositoStatus').val("Approved");
					}
					$('#depositoStatusHidden').val(data.depositoStatus);
					$('#tabDetailCertificate #accountNo').val(data.accountNo);
					$('#tabDetailCertificate #accountKey').val(data.accountKey);
					$('#tabDetailCertificate #accountName').val(data.accountName);
					$('#tabDetailCertificate #securityType').val(data.securityType);
					$('#tabDetailCertificate #securityCode').val(data.securityCode);
					$('#tabDetailCertificate #securityDesc').val(data.securityDesc);
					$('#tabDetailCertificate #securityKey').val(data.securityKey);
					$('#currencyCode').val(data.currencyCode);
					$('#thirdPartyCode').val(data.thirdPartyCode);
					$('#thirdPartyName').val(data.thirdPartyName);
					$('#branchCode').val(data.branchCode);
					$("input[name='tdMaster.script']").val(data.script);
					$("#script1").attr('checked', "true");
					$("#script2").attr('checked', "");
					$('#scriptHidden').val(data.script);
					$('#nominal').val(data.nominal);
					$('#nominalStripped').val(data.nominal);
					$('#interestRate').val(data.interestRate);
					$('#maturityDate').val(data.maturityDate);
					
					$('#h_depositoNo').val(data.depositoNo);
					$('#h_depositoKey').val(data.depositoKey);
					$('#h_amountStripped').val(data.amount);
					$('#h_placementDate').val(data.placementDate);
					$('#h_depositoStatus').val(data.depositoStatus);
					$('#tabDetailCertificate #h_accountNo').val(data.accountNo);
					$('#tabDetailCertificate #h_accountKey').val(data.accountKey);
					$('#tabDetailCertificate #h_accountName').val(data.accountName);
					$('#tabDetailCertificate #h_securityType').val(data.securityType);
					$('#tabDetailCertificate #h_securityCode').val(data.securityCode);
					$('#tabDetailCertificate #h_securityDesc').val(data.securityDesc);
					$('#tabDetailCertificate #h_securityKey').val(data.securityKey);
					$('#h_currencyCode').val(data.currencyCode);
					$('#h_thirdPartyCode').val(data.thirdPartyCode);
					$('#h_thirdPartyName').val(data.thirdPartyName);
					$('#h_branchCode').val(data.branchCode);
					$('#h_scriptHidden').val(data.script);
					$('#h_nominalStripped').val(data.nominal);
					$('#h_interestRate').val(data.interestRate);
					$('#h_maturityDate').val(data.maturityDate);
				}
			}, function(data){
				$('#depositoNo').addClass('fieldError');
				$('#depositoNo').val('');
				$('#depositoKey').val('');
				$('#amount').val('');
				$('#amountStripped').val('');
				$('#placementDate').val('');
				$('#depositoStatus').val('');
				$('#currencyCode').val('');
				$('#thirdPartyCode').val('');
				$('#thirdPartyName').val('');
				$('#branchCode').val('');
				$('#script').val('');
				$('#scriptHidden').val('');
				$('#nominal').val('');
				$('#nominalStripped').val('');
				$('#interestRate').val('');
				$('#maturityDate').val('');
				
				$('#h_depositoNo').val('');
				$('#h_depositoKey').val('');
				$('#h_amountStripped').val('');
				$('#h_placementDate').val('');
				$('#h_depositoStatus').val('');
				$('#tabDetailCertificate #h_accountNo').val('');
				$('#tabDetailCertificate #h_accountKey').val('');
				$('#tabDetailCertificate #h_accountName').val('');
				$('#tabDetailCertificate #h_securityType').val('');
				$('#tabDetailCertificate #h_securityCode').val('');
				$('#tabDetailCertificate #h_securityDesc').val('');
				$('#tabDetailCertificate #h_securityKey').val('');
				$('#h_currencyCode').val('');
				$('#h_thirdPartyCode').val('');
				$('#h_thirdPartyName').val('');
				$('#h_branchCode').val('');
				$('#h_scriptHidden').val('');
				$('#h_nominalStripped').val('');
				$('#h_interestRate').val('');
				$('#h_maturityDate').val('');
			});
		}
		attachDepositoNo();
		
		var securityCodeFilter = "_";
		if ($('#securityType').val() != "") {
			securityCodeFilter = $('#securityType').val();
			if ($('#accountKey').val() !=""){
				securityCodeFilter = securityCodeFilter+"-"+$('#accountKey').val();
			}else{
				securityCodeFilter = securityCodeFilter+"-"+" ";
			}
		}else {
			securityCodeFilter = " ";
			if ($('#accountKey').val() !=""){
				securityCodeFilter = securityCodeFilter+"-"+$('#accountKey').val();
			}else{
				securityCodeFilter = securityCodeFilter+"-"+" ";
			}
		}
		
		securityCode(securityCodeFilter);
		
		$('#securityType').blur(function() {
			
			if (($('#securityType').val() == "")) {
				clearDeposito();
// 				tableCertificateTransDetail.fnClearTable();
				$('#currentHolding').val('');
				$('#securityKey').val("");
				$('#securityCode').val("");
				$('#securityCodeDesc').val("");
				$('#h_securityCodeDesc').val("");
				$('#h_securityTypeDesc').val("");
				securityCode("");
			}
		}); 
		
		$('#securityType').lookup({
				list:'@{Pick.securityTypesDeposito()}',
				get:{
					url:'@{Pick.securityTypeDeposito()}',
					success: function(data){
							var securityTypeDesc = $('#securityTypeDesc').val();
							if(securityTypeDesc != data.description){
								clearDeposito();
// 								tableCertificateTransDetail.fnClearTable();
								$('#currentHolding').val('');
								$('#securityKey').val("");
								$('#securityCode').val("");
								$('#securityCodeDesc').val("");
								$('#h_securityCodeDesc').val("");
							}
							$('#securityType').removeClass('fieldError');
							$('#securityTypeDesc').val(data.description);
							$('#h_securityTypeDesc').val(data.description);
							$('#tabCertificate').val(data.tabCertificate);
							if (jQuery.trim($("#tabCertificate").val()) == "0"){
								$("#tabDetailCertificate").tabs("enable",0);
								$("#tabDetailCertificate").tabs("select",0);
								$("#tabDetailCertificate").tabs("disable",1);
							}else if (jQuery.trim($("#tabCertificate").val()) == "1"){
								$("#tabDetailCertificate").tabs("enable",1);
								$("#tabDetailCertificate").tabs("select",1);
								$("#tabDetailCertificate").tabs("disable",0);
							}
							
							
							securityCode($('#securityType').val()+"-"+$('#accountKey').val());
					},
					error: function(data){
						$('#securityType').addClass('fieldError');
						$('#securityType').val('');
						$('#securityTypeDesc').val('NOT FOUND');
						$('#h_securityTypeDesc').val('');
						clearDeposito();
// 						tableCertificateTransDetail.fnClearTable();
						$('#currentHolding').val('');
						$('#securityKey').val("");
						$('#securityCode').val("");
						$('#securityCodeDesc').val("");
						$('#h_securityCodeDesc').val("");
						$('#h_securityTypeDesc').val("");
					}
			},
			//filter:$('#securityType'),
			description:$('#securityTypeDesc'),
			help:$('#securityTypeHelp')
		});
		
		$('#securityCode').blur(function() {
			if ($('#securityCode').val() == "") {
				clearDeposito();
// 				tableCertificateTransDetail.fnClearTable();
				$('#h_securityCodeDesc').val("");
				$('#currentHolding').val('');
				$('#currentHoldingStripped').val('');
			}
		});
		
		/*$('#certificateId').blur(function(){
			if ($(this).val() != ""){
				
				if ($('#certificateIdHidden').val() != $('#certificateId').val()) {
					var arrActiveCertId = '${activeCertificateNo}'.split("|");
					for (var i = 0 ; i < arrActiveCertId.length; i++) {
						if (arrActiveCertId[i] == $('#certificateId').val()) {
							$('#certificateId').addClass("fieldError");
							$("#CertificateForm").find("span[id='certificateIdError']").html(" already exist");
							$('#certificateId').val("");
							break;
						}else {
							$('#certificateId').removeClass("fieldError");
							$("#CertificateForm").find("span[id='certificateIdError']").html("");
						}
					}
				}
				
			}
		});*/
});
	
	function clearDeposito(){
		$('#depositoNo').val('');
		$('#depositoKey').val('');
		$('#amount').val('');
		$('#amountStripped').val('');
		$('#placementDate').val('');
		$('#depositoStatus').val('');
		$('#h_depositoStatus').val('');
		$('#depositoStatusHidden').val('');
		$('#tabDetailCertificate #accountNo').val('');
		$('#tabDetailCertificate #accountKey').val('');
		$('#tabDetailCertificate #accountName').val('');
		$('#tabDetailCertificate #securityType').val('');
		$('#tabDetailCertificate #securityCode').val('');
		$('#tabDetailCertificate #securityDesc').val('');
		$('#tabDetailCertificate #securityKey').val('');
		$('#tabDetailCertificate #currencyCode').val('');
		$('#thirdPartyCode').val('');
		$('#thirdPartyName').val('');
		$('#branchCode').val('');
		$('#script').val('');
		$('#scriptHidden').val('');
		$('#nominal').val('');
		$('#nominalStripped').val('');
		$('#interestRate').val('');
		$('#maturityDate').val('');
	}


	function securityCode(pdata) {
		var securityType = $('#securityType').val();
		if (securityType == '') { securityType="DUMMY"; }
		var pickName = (securityType == '') ? 'PICK_SC_MASTER' : 'PICK_SC_MASTER_BY_SEC_TYPE';
		$('#securityCode').dynapopup2({key:'securityKeys', help:'securityCodeHelp', desc:'securityCodeDesc'}, pickName, securityType, 'certificateId', function(sdata){
			var data = $().fetchSync("@{Pick.securitygetQuantity()}", {'code':$('#securityCode').val(), 'filter':pdata});
			if (data) {
				var securityKey = $('#securityKey').val();
				if(securityKey != data.code){
// 					tableCertificateTransDetail.fnClearTable();
				}
				$('#securityCode').removeClass('fieldError');
				$('#securityKey').val(data.code);
				$('#securityCodeDesc').val(data.description);
				$('#h_securityCodeDesc').val(data.description);
				$('#certificateCurrency').val(data.currency);
				$('#h_certificateCurrency').val(data.currency);
				$('#currentHolding').val($('#dummy').myAutoNumericGet(data.currentHolding));
				$('#currentHoldingStripped').val(data.currentHolding);
				$('#filterDeposito').val($('#accountKey').val()+"-"+$('#securityKey').val());
			}
			$('#securityCode').trigger("refreshDepositoPopup");
			clearDeposito();
		},function(data){
			$('#securityCode').addClass('fieldError');
			$('#securityCodeDesc').val('NOT FOUND');
			//$('#securityKey').val(data.code);
			$('#securityKey').val('');
			$('#securityCode').val('');
			$('#h_securityCodeDesc').val('');
			$('#certificateCurrency').val('');
			$('#currentHolding').val('');
			$('#currentHoldingStripped').val('');
			$('#h_certificateCurrency').val('');
			$('#securityCode').trigger("refreshDepositoPopup");
			clearDeposito();
		});
	}
	
	function tabCertificateTrans(data) {
		var certificateTrans;
		
		#{if '${certificateTrans}' != '' }
			certificateTrans = ${certificateTrans.raw()}
		#{/if}
		#{if '${certificateTrans}' == '' }
			certificateTrans = new Array();
		#{/if}
		
		fmtDate = '${appProp?.jqueryDateFormat}';
		
		tableCertificateTransDetail = 
			$('#gridCertificateTrans').dataTable({
				aaData: certificateTrans,
				aoColumns: [ 
				             {
				 				fnRender: function(obj) {
								  	var controls;
									controls = obj.aData.transactionNumber;
									controls += '<input type="hidden" name="listTransactions[' + obj.iDataRow + '].transactionNumber" value="' + obj.aData.transactionNumber + '" />';
								  	return controls;
								 }
							  }, 
							  {
								  fnRender: function(obj) {
									  	controls = obj.aData.holdingRefs;
										controls += '<input type="hidden" name="listTransactions[' + obj.iDataRow + '].holdingRefs" value="' + obj.aData.holdingRefs + '" />';
									  	return controls;
								  }
							  },
							  {
								  fnRender: function(obj) {
									  	if (obj.aData.transactionTemplate == null) {
									  		obj.aData.transactionTemplate = new Object();
									  		obj.aData.transactionTemplate.description = "";
									  	}
									  	var controls;
										controls = obj.aData.transactionTemplate.description;
										controls += '<input type="hidden" name="listTransactions[' + obj.iDataRow + '].transactionTemplate.description" value="' + obj.aData.transactionTemplate.description + '" />';
									  	return controls;
								  }
							  },
							  {
								  sClass: 'numeric',
								  fnRender: function(obj) {
									  if ( obj.aData.quantity == null) {
										  obj.aData.quantity = "";
									  }	
									  var controls;
										controls = $('#dummy').myAutoNumericGet(obj.aData.quantity);
									  	controls += '<input type="hidden" name="listTransactions[' + obj.iDataRow + '].quantity" value="' + obj.aData.quantity + '" />';
									  return controls;
								  }
							  },
							  {
								  fnRender: function(obj) {
									  if (obj.aData.transactionStatus == null) {
										  obj.aData.transactionStatus = "";
									  }	
									  var controls;
									  	if (jQuery.trim(obj.aData.transactionStatus) == 'S'){
									  		controls = "Settled";
									  	}else{
									  		controls = obj.aData.transactionStatus;
									  		
									  	}
									  	controls += '<input type="hidden" name="listTransactions[' + obj.iDataRow + '].transactionStatus" value="' + obj.aData.transactionStatus + '" />';
									  return controls;
								  }
							  },
							  
							  {
								fnRender: function(obj) {
							 	var controls;
							 	controls = '<center><input id="deleteButton" type="button" value="delete" #{if readOnly}disabled="disabled"#{/if} /></center>';
							 	controls += '<input type="hidden" name="listTransactions[' + obj.iDataRow + '].account.accountNo" value="' + obj.aData.account.accountNo + '" />';
							 	controls += '<input type="hidden" name="listTransactions[' + obj.iDataRow + '].account.custodyAccountKey" value="' + obj.aData.account.custodyAccountKey + '" />';
							 	controls += '<input type="hidden" name="listTransactions[' + obj.iDataRow + '].account.name" value="' + obj.aData.account.name + '" />';
							 	controls += '<input type="hidden" name="listTransactions[' + obj.iDataRow + '].security.securityKey" value="' + obj.aData.security.securityKey + '" />';
							 	controls += '<input type="hidden" name="listTransactions[' + obj.iDataRow + '].security.securityId" value="' + obj.aData.security.securityId + '" />';
							 	controls += '<input type="hidden" name="listTransactions[' + obj.iDataRow + '].security.description" value="' + obj.aData.security.description + '" />';
							 	controls += '<input type="hidden" name="listTransactions[' + obj.iDataRow + '].security.securityType.securityType" value="' + obj.aData.security.securityType.securityType + '" />';
							 	controls += '<input type="hidden" name="listTransactions[' + obj.iDataRow + '].securityType.securityType" value="' + obj.aData.security.securityType.securityType + '" />';
							 	
							
							 	var stringSetDate = obj.aData.settlementDate.toString();
							 	var settlementDate;
							 	if (stringSetDate.substr(2,1) != "/") {
							 		settlementDate = $.datepicker.formatDate(fmtDate, new Date(obj.aData.settlementDate));
							 	} else {
							 		settlementDate = obj.aData.settlementDate;
							 	}	
							 	var stringSetTransactionDate = obj.aData.transactionDate.toString();
							 	var transactionDate;
							 	if (stringSetTransactionDate.substr(2,1) != "/") {
							 		transactionDate = $.datepicker.formatDate(fmtDate, new Date(obj.aData.transactionDate));
							 	} else {
							 		transactionDate = obj.aData.transactionDate;
							 	}
							 	controls += '<input type="hidden" name="listTransactions[' + obj.iDataRow + '].settlementDate" value="' + settlementDate + '" />';
							 	controls += '<input type="hidden" name="listTransactions[' + obj.iDataRow + '].transactionDate" value="' + transactionDate + '" />';
							 	controls += '<input type="hidden" name="listTransactions[' + obj.iDataRow + '].price" value="' + obj.aData.price + '" />';
							 	controls += '<input type="hidden" name="listTransactions[' + obj.iDataRow + '].transactionKey" value="' + obj.aData.transactionKey + '" />';
							 	controls += '<input type="hidden" name="listTransactions[' + obj.iDataRow + '].transactionTemplate.transactionCode" value="' + obj.aData.transactionTemplate.transactionCode + '" />';
							 	controls += '<input type="hidden" name="listTransactions[' + obj.iDataRow + '].transactionTemplate.transactionDescription" value="' + obj.aData.transactionTemplate.description + '" />';
							 	controls += '<input type="hidden" name="listTransactions[' + obj.iDataRow + '].transactionTemplate.transactionTemplateKey" value="' + obj.aData.transactionTemplate.transactionTemplateKey + '" />';
							 	controls += '<input type="hidden" name="listTransactions[' + obj.iDataRow + '].amount" value="' + obj.aData.amount + '" />';
							 	controls += '<input type="hidden" name="listTransactions[' + obj.iDataRow + '].settlementAmount" value="' + obj.aData.settlementAmount + '" />';
							 	
							 	return controls;
							 	}
							  }
							  
							],
				aaSorting:[[1,'asc']],
	        	bAutoWidth: false,		
	        	bDestroy: true,
	        	bFilter: false,
	        	bInfo: false,
	        	//bRetrieve:true,
	        	//bServerSide: true,
	        	bJQueryUI: true,
	        	bPaginate: false,
	        	bSearch: false,
	        	bLengthChange: false,
	        	isDisplayLength:10                						
		});
		
		$('#listCertificateTrans #gridCertificateTrans').removeAttr('style');
		$('#listCertificateTrans #gridCertificateTrans tbody tr td').die('click');
		$('#listCertificateTrans #gridCertificateTrans tbody tr td').live('click', function(){
			var rowPos= $(this).parents('tr');
			if (tableCertificateTransDetail.fnGetNodes().length == 0) {
				return false;
			}
			var rowPosNumber = tableCertificateTransDetail.fnGetPosition(rowPos[0]);
			var pos = tableCertificateTransDetail.fnGetPosition(this);
			cell = tableCertificateTransDetail.fnGetData(this.parentNode);
			if (pos[1] != 5) {
				dataCertificateDetail = tableCertificateTransDetail.fnGetData(this.parentNode);
				$("#detailForCertificateTransDetails #detailCertificateTransForm .errmsg").html("");
				$("#detailForCertificateTransDetails #detailCertificateTransForm").find("span[id*='Error']").html("");
				$("#detailForCertificateTransDetails #detailCertificateTransForm #transactionNo").removeClass('fieldError');
				$("#detailForCertificateTransDetails #detailCertificateTransForm #rowPosition").val(rowPosNumber);
				$("#detailForCertificateTransDetails #detailCertificateTransForm #transactionNo").val(dataCertificateDetail.transactionNumber);
				$("#detailForCertificateTransDetails #detailCertificateTransForm #transactionKey").val(dataCertificateDetail.transactionKey);
				var stringTransDate = dataCertificateDetail.transactionDate.toString();
				if (stringTransDate.substr(2,1) != "/") {
					$("#detailForCertificateTransDetails #detailCertificateTransForm #transactionDate").val($.datepicker.formatDate(fmtDate, new Date(dataCertificateDetail.transactionDate)));	
				} else {
					$("#detailForCertificateTransDetails #detailCertificateTransForm #transactionDate").val(dataCertificateDetail.transactionDate);
				}
				
				$("#detailForCertificateTransDetails #detailCertificateTransForm #transactionStatus").val(dataCertificateDetail.transactionStatus);
				$("#detailForCertificateTransDetails #detailCertificateTransForm #accountNo").val(dataCertificateDetail.account.accountNo);
				$("#detailForCertificateTransDetails #detailCertificateTransForm #accountKey").val(dataCertificateDetail.account.custodyAccountKey);
				$("#detailForCertificateTransDetails #detailCertificateTransForm #accountName").val(dataCertificateDetail.account.name);
				$("#detailForCertificateTransDetails #detailCertificateTransForm #description").val(dataCertificateDetail.transactionTemplate.description);
				$("#detailForCertificateTransDetails #detailCertificateTransForm #securityKey").val(dataCertificateDetail.security.securityKey);
				$("#detailForCertificateTransDetails #detailCertificateTransForm #securityCode").val(dataCertificateDetail.security.securityId);
				$("#detailForCertificateTransDetails #detailCertificateTransForm #securityDesc").val(dataCertificateDetail.security.description);
				$("#detailForCertificateTransDetails #detailCertificateTransForm #securityType").val(dataCertificateDetail.security.securityType.securityType);
				var stringSetDate = dataCertificateDetail.settlementDate.toString();
				if (stringSetDate.substr(2,1) != "/") {
					$("#detailForCertificateTransDetails #detailCertificateTransForm #settlementDate").val($.datepicker.formatDate(fmtDate, new Date(dataCertificateDetail.settlementDate)));
				} else {
					$("#detailForCertificateTransDetails #detailCertificateTransForm #settlementDate").val(dataCertificateDetail.settlementDate);
				}
				
				$('#detailForCertificateTransDetails #detailCertificateTransForm #quantity').val($('#dummy').myAutoNumericGet(dataCertificateDetail.quantity));
				$('#detailForCertificateTransDetails #detailCertificateTransForm #price').val($('#dummy').myAutoNumericGet(dataCertificateDetail.price));
				$('#detailForCertificateTransDetails #detailCertificateTransForm #amount').val($('#dummy').myAutoNumericGet(dataCertificateDetail.amount));
				$('#detailForCertificateTransDetails #detailCertificateTransForm #settlementAmount').val($('#dummy').myAutoNumericGet(dataCertificateDetail.settlementAmount));
				
				$("#detailForCertificateTransDetails #detailCertificateTransForm #quantityStripped").val(dataCertificateDetail.quantity);
				$("#detailForCertificateTransDetails #detailCertificateTransForm #priceStripped").val(dataCertificateDetail.price);
				$('#detailForCertificateTransDetails #detailCertificateTransForm #amountStripped').val(dataCertificateDetail.amount);
				$('#detailForCertificateTransDetails #detailCertificateTransForm #settlementAmountStripped').val(dataCertificateDetail.settlementAmount);
				
				
				$("#detailForCertificateTransDetails #detailCertificateTransForm #transactionCode").val(dataCertificateDetail.transactionTemplate.transactionCode );
				$("#detailForCertificateTransDetails #detailCertificateTransForm #transactionDescription").val(dataCertificateDetail.transactionTemplate.description);
				$("#detailForCertificateTransDetails #detailCertificateTransForm #transactionTemplateKey").val(dataCertificateDetail.transactionTemplate.transactionTemplateKey);
				
				$('#detailForCertificateTransDetails #detailCertificateTransForm  #oldTransactionKey').val($('#detailForCertificateTransDetails #detailCertificateTransForm #transactionNo').val());
				$('#detailForCertificateTransDetails #detailCertificateTransForm  #newTransactionKey').val($('#detailForCertificateTransDetails #detailCertificateTransForm #oldTransactionKey').val());
				$('#detailForCertificateTransDetails #detailCertificateTransForm  #filter').val($('#CertificateForm  #custodyAccountKey').val()+"-"+$('#CertificateForm  #securityKey').val());
				transactionNo($('#detailForCertificateTransDetails #detailCertificateTransForm  #filter').val());
				$("#detailForCertificateTransDetails").dialog('open');
				
			}
			
		});
	
	}
	
	function reordering() {
		var grid = $('#gridCertificateTrans tbody');
		var trs = $("tr", grid);
		
		$.each(trs, function(idx, data){
			var hiddens = $("[type=hidden]", $(this));
			
			$(hiddens).eq(0).attr("name", "listTransactions["+idx+"].transactionNumber");
			$(hiddens).eq(1).attr("name", "listTransactions["+idx+"].transactionDate");
			$(hiddens).eq(2).attr("name", "listTransactions["+idx+"].transactionTemplate.description");
			$(hiddens).eq(3).attr("name", "listTransactions["+idx+"].quantity");
			$(hiddens).eq(4).attr("name", "listTransactions["+idx+"].transactionStatus");
			$(hiddens).eq(5).attr("name", "listTransactions["+idx+"].account.accountNo");
			$(hiddens).eq(6).attr("name", "listTransactions["+idx+"].account.custodyAccountKey");
			$(hiddens).eq(7).attr("name", "listTransactions["+idx+"].account.account.name");
			$(hiddens).eq(8).attr("name", "listTransactions["+idx+"].security.securityKey");
			$(hiddens).eq(9).attr("name", "listTransactions["+idx+"].security.securityId");
			$(hiddens).eq(10).attr("name", "listTransactions["+idx+"].security.description");
			$(hiddens).eq(11).attr("name", "listTransactions["+idx+"].security.securityType.securityType");
			$(hiddens).eq(12).attr("name", "listTransactions["+idx+"].settlementDate");
			$(hiddens).eq(13).attr("name", "listTransactions["+idx+"].price");
			$(hiddens).eq(14).attr("name", "listTransactions["+idx+"].transactionKey");
		});
	}
	
	function transactionNo(filters) {
		$('#detailForCertificateTransDetails #detailCertificateTransForm #transactionNo').lookup({
			list:'@{Pick.transactionsDetail()}',
			get:{
				url:'@{Pick.transaction()}',
				success: function(data) {
					if (data) {
						$('#detailForCertificateTransDetails #detailCertificateTransForm #transactionNo').removeClass('fieldError');
						$('#detailForCertificateTransDetails #detailCertificateTransForm #transactionKey').val(data.transactionKey);
						//$('#detailForCertificateTransDetails #detailCertificateTransForm #transactionDate').val(new Date(data.transactionDate).format("mm/dd/yyyy"));
						$('#detailForCertificateTransDetails #detailCertificateTransForm #transactionDate').val(data.transactionDate);
						$('#detailForCertificateTransDetails #detailCertificateTransForm #transactionStatus').val(data.transactionStatus);
						$('#detailForCertificateTransDetails #detailCertificateTransForm #accountNo').val(data.accountNo);
						$('#detailForCertificateTransDetails #detailCertificateTransForm #accountKey').val(data.accountKey);
						$('#detailForCertificateTransDetails #detailCertificateTransForm #accountName').val(data.accountDesc);
						$('#detailForCertificateTransDetails #detailCertificateTransForm #description').val(data.description);
						$('#detailForCertificateTransDetails #detailCertificateTransForm #securityCode').val(data.securityCode);
						$('#detailForCertificateTransDetails #detailCertificateTransForm #securityDesc').val(data.securityDesc);
						$('#detailForCertificateTransDetails #detailCertificateTransForm #securityType').val(data.securityType);
						$('#detailForCertificateTransDetails #detailCertificateTransForm #securityKey').val(data.securityKey);
						//$('#detailForCertificateTransDetails #detailCertificateTransForm #settlementDate').val(new Date(data.settlemetDate).format("mm/dd/yyyy"));
						$('#detailForCertificateTransDetails #detailCertificateTransForm #settlementDate').val(data.settlemetDate);
						$('#detailForCertificateTransDetails #detailCertificateTransForm #holdingRefs').val(data.holdingRefs);
						$('#detailForCertificateTransDetails #detailCertificateTransForm #quantity').val($('#dummy').myAutoNumericGet(data.quantity));
						$('#detailForCertificateTransDetails #detailCertificateTransForm #price').val($('#dummy').myAutoNumericGet(data.price));
						$('#detailForCertificateTransDetails #detailCertificateTransForm #quantityStripped').val(data.quantity);
						$('#detailForCertificateTransDetails #detailCertificateTransForm #priceStripped').val(data.price);
						$('#detailForCertificateTransDetails #detailCertificateTransForm #settlementAmount').val($('#dummy').myAutoNumericGet(data.settlementAmount));
						$('#detailForCertificateTransDetails #detailCertificateTransForm #settlementAmountStripped').val(data.settlementAmount);
						$('#detailForCertificateTransDetails #detailCertificateTransForm #amount').val($('#dummy').myAutoNumericGet(data.amount));
						$('#detailForCertificateTransDetails #detailCertificateTransForm #amountStripped').val(data.amount);
						$('#detailForCertificateTransDetails #detailCertificateTransForm #transactionCode').val(data.transCodeTemplate);
						$('#detailForCertificateTransDetails #detailCertificateTransForm #transactionDescription').val(data.transDescTemplate);
						$('#detailForCertificateTransDetails #detailCertificateTransForm #transactionTemplateKey').val(data.transKeyTemplate);
						
					}
				},
				error : function(data) {
					$('#detailForCertificateTransDetails #detailCertificateTransForm #transactionNo').addClass('fieldError');
					$('#detailForCertificateTransDetails #detailCertificateTransForm #transactionNo').val('');
					$('#detailForCertificateTransDetails #detailCertificateTransForm #transactionKey').val('');
					$('#detailForCertificateTransDetails #detailCertificateTransForm #transactionDate').val('');
					$('#detailForCertificateTransDetails #detailCertificateTransForm #transactionStatus').val('');
					$('#detailForCertificateTransDetails #detailCertificateTransForm #accountNo').val('');
					$('#detailForCertificateTransDetails #detailCertificateTransForm #accountKey').val('');
					$('#detailForCertificateTransDetails #detailCertificateTransForm #accountName').val('');
					$('#detailForCertificateTransDetails #detailCertificateTransForm #description').val('');
					$('#detailForCertificateTransDetails #detailCertificateTransForm #securityKey').val('');
					$('#detailForCertificateTransDetails #detailCertificateTransForm #securityCode').val('');
					$('#detailForCertificateTransDetails #detailCertificateTransForm #securityDesc').val('');
					$('#detailForCertificateTransDetails #detailCertificateTransForm #securityType').val('');
					$('#detailForCertificateTransDetails #detailCertificateTransForm #securityKey').val('');
					$('#detailForCertificateTransDetails #detailCertificateTransForm #settlementDate').val('');
					$('#detailForCertificateTransDetails #detailCertificateTransForm #quantity').val('');
					$('#detailForCertificateTransDetails #detailCertificateTransForm #price').val('');
					$('#detailForCertificateTransDetails #detailCertificateTransForm #quantityStripped').val('');
					$('#detailForCertificateTransDetails #detailCertificateTransForm #priceStripped').val('');
					$('#detailForCertificateTransDetails #detailCertificateTransForm #settlementAmount').val('');
					$('#detailForCertificateTransDetails #detailCertificateTransForm #settlementAmountStripped').val('');
					$('#detailForCertificateTransDetails #detailCertificateTransForm #holdingRefs').val('');
					$('#detailForCertificateTransDetails #detailCertificateTransForm #amount').val('');
					$('#detailForCertificateTransDetails #detailCertificateTransForm #amountStripped').val('');
					$('#detailForCertificateTransDetails #detailCertificateTransForm #transactionCode').val('');
					$('#detailForCertificateTransDetails #detailCertificateTransForm #transactionDescription').val('');
					$('#detailForCertificateTransDetails #detailCertificateTransForm #transactionTemplateKey').val('');
				}
			},
			filter:filters,
			//key:$('#branchKey'),
			//description:$('#branchName'),
			help:$('#transactionHelp')
		});
	}

</script>
<style type="text/css">
 
}
</style>
<h2>Certificate Management</h2>
#{if flash.error || errors}
    <div class="error">
    	Error when saving data!<br/>
    	#{if flash.error}
			<li>${flash.error}</li>
		#{/if}
		#{ifErrors}
			#{errors}
				 <li>${error.key} ${error}</li>
			#{/errors}
		#{/ifErrors}
    </div>
#{/if}

<form id="CertificateForm" class="form" method="POST" encType="multipart/form-data">
		#{hidden id:'status', name:'status', value:status /}
		#{hidden id:'certificateKey', name:'certificate.certificateKey', value:certificate?.certificateKey /}
		#{hidden id:'filterDeposito', name:'filterDeposito',value:'' /}
		#{hidden id:'tabCertificate', name:'certificate.tabCertificate',value:certificate?.tabCertificate /}
		#{hidden id:'applicationDate', name:'certificate.applicationDate', value:certificate?.applicationDate.format(appProp.dateFormat) /}
		<p>
			#{textBox id:'accountNo', name:'certificate.account.accountNo', label:'Account No', value:certificate?.account?.accountNo, required:true, class:'capitalize', readOnly:readOnly, width:'120px' /}
			#{hidden id:"accountKey", name:'certificate.account.custodyAccountKey', value:certificate?.account?.custodyAccountKey /}
			#{button id:'accountHelp', value:'?', class:'small', readOnly:readOnly /}
			#{textBox id:'accountName', name:'certificate.account.name', value:certificate?.account?.name, readOnly:true, width:'241.5px' /}
			<span id="accountNoError" class="error">#{error 'Account No is' /}</span>
		</p>
		<p>
			#{textBox id:'securityType', name:'certificate.security.securityType.securityType', label:'Security Type', value:certificate?.security?.securityType?.securityType, class:'lookup capitalize',required:true,  readOnly:readOnly, width:'120px' /}
			#{button id:'securityTypeHelp', value:'?', class:'small', readOnly:readOnly /}
			#{textBox id:'securityTypeDesc', name:'certificate.security.securityType.description', value:certificate?.security?.securityType?.description, readOnly:true, width:'241.5px' /}
			<span id="securityTypeError" class="error">#{error 'Security Type is' /}</span>
		</p>
		<p>
			#{textBox id:'securityCode', name:'certificate.security.securityId', label:'Security Code', class:'capitalize', value:certificate?.security?.securityId, required:true, readOnly:readOnly, width:'120px' /}
			#{button id:'securityCodeHelp', value:'?', class:'small', readOnly:readOnly /}
			#{textBox id:'securityCodeDesc', name:'certificate.security.description', value:certificate?.security?.description, readOnly:true, width:'241.5px' /}
			#{hidden id:'securityKey', name:'certificate.security.securityKey', value:certificate?.security?.securityKey /}
			#{hidden id:'custodyAccountKey', name:'certificate.account.custodyAccountKey', value:certificate?.account?.custodyAccountKey /}
			<span id="securityCodeError" class="error">#{error 'Security Code is' /}</span>
		</p>	
		<p>
			#{textBox id:'certificateId', name:'certificate.certificateId', label:'Certificate No', value:certificate?.certificateId, class:'capitalize',readOnly:readOnly, required:true, width:'120px',maxLength:50 /}
			<span id="certificateIdError" class="error">#{error 'Certificate No is' /}</span>
			#{hidden id:'certificateIdHidden', value:certificate?.certificateId  /}
		</p>
		<p>
			#{textBox id:'certificateAccountNo', name:'certificate.certificateAccountNo', label:'Account #', value:certificate?.certificateAccountNo, class:'capitalize',readOnly:readOnly, width:'120px',maxLength:50 /}
			<span id="certificateAccountNoError" class="error">#{error 'Account # is' /}</span>
		</p>
		<p>
			#{textBox id:'certificateDate', name:'certificate.certificateDate', label:'Received Date', value:certificate?.certificateDate?.format(appProp.dateFormat), class:'calendar',readOnly:readOnly, required:true, width:'120px' /}
			<span id="certificateDateError" class="error">#{error 'Certificate Date is' /}</span>
		</p>
		
		<p>
			#{textBox id:'certificateQuantity', name:'certificateQuantity', label:'Certificate Quantity', value:certificate?.quantity, format:'#,##0.####', class:'numeric', width:'120px',readOnly:readOnly, required:true /}
			#{hidden id:'certificateQuantityStripped', name:'certificate.quantity', value:certificate?.quantity /}		
			<span id="certificateQuantityError" class="error">#{error 'Certificate Quantity' /}</span>
		</p>
		<p>
			#{textBox id:'certificateCurrency', name:'certificate.security.currency.currencyCode', value:certificate?.security?.currency?.currencyCode, label:'Currency',class:'capitalize',readOnly:true,width:'120px' /}		
			<span id="certificateCurrencyError" class="error">#{error 'Currency is' /}</span>
		</p>
		<p>
			#{textBox id:'denomination', name:'denomination', label:'Denomination', value:certificate?.denomination, class:'numeric', format:'#,##0.####', width:'120px', readOnly:readOnly, required:true /}
			#{hidden id:'denominationStripped', name:'certificate.denomination', value:certificate?.denomination /}		
			<span id="denominationError" class="error">#{error 'Denomination is' /}</span>
		</p>
		<p>
			#{textBox id:'portModeCode', name:'certificate.portMode.lookupCode', label:'Port Move', value:certificate?.portMode?.lookupCode, class:'capitalize', required:true, readOnly:readOnly, width:'120px' /}
			#{hidden id:'portMode', name:'certificate.portMode.lookupId', value:certificate?.portMode?.lookupId /}
			#{button id:'portModeHelp', value:'?', class:'small', readOnly:readOnly /}	
			#{textBox id:'portModeDesc', name:'certificate.portMode.lookupDescription', value:certificate?.portMode?.lookupDescription, readOnly:true, width:'241.5px' /}
			<span id="portModeCodeError" class="error">#{error 'Port Move is' /}</span>
		</p>
		<p>
			#{radioButton id:'isActive', name:'isActive', value:((certificate?.isActive)?'true':'false'), label:'Active', options:operators, readOnly:readOnly /}
			#{hidden id:'isActiveHidden', name:'certificate.isActive', value:((certificate?.isActive)?'true':'false') /}
		</p>
		<p id='inactiveDateId'>
			#{textBox id:'inactiveDate', name:'certificate.inactiveDate', label:'Inactive Date', value:certificate?.inactiveDate?.format(appProp.dateFormat), class:'calendar',readOnly:readOnly, required:true, width:'120px' /}
			<span id="inactiveDateError" class="error">#{error 'Inactive Date is' /}</span>
		</p>

<div id="tabDetailCertificate" >
		<ul>
<!-- 			<li><a href="#tab0" id="changeTransaction">Transaction</a></li> -->
			<li><a href="#tab1" id="changeDeposito">Deposito</a></li>
			<li><a href="#tab2" id="changeAdditional">Additional</a></li>
		</ul>
<!-- 		<div id="tab0">	 -->
<!-- 			<p> -->
<!-- 				#{textBox id:'currentHolding', name:'currentHolding', label:'Current Holding', value:certificate?.currentHolding, format:'#,##0.####',class:'numeric',readOnly:true, width:'120px' /} -->
<!-- 				#{hidden id:'currentHoldingStripped', name:'certificate.currentHolding', value:certificate?.currentHolding /}	 -->
<!-- 			</p> -->
<!-- 			<div id="listCertificateTrans" style="overflow-y:scroll;height:80px;width:800px"> -->
<!-- 				#{include 'Certificates/grid_certificate_trans.html' /} -->
<!-- 			</div> -->
<!-- 			<div class="buttons"> -->
<!-- 				#{ifnot confirming} -->
<!-- 					<button type="button" id="newCertificateTransDetail" #{if readOnly}disabled="disabled"#{/if}>Add</button> -->
<!-- 				#{/ifnot} -->
<!-- 			</div> -->
<!-- 		</div> -->
		<div id="tab1">
			#{include 'Certificates/tabCertificateDeposito.html' /}
		</div>
		<div id="tab2">
			#{include 'Certificates/tabCertificateAdditional.html' /}
		</div>		
</div>


<div class="buttons">
		#{if confirming}
			<input type="button" id="confirmData" value="Confirm" />
			
			<button id="back">Back</button>
		#{/if}
		#{else}	
			#{if mode == 'view'}
					<button id="cancel">Close</button>
			#{/if}
			#{else}
				<button id="save" type="button">Save</button>
				<button id="cancel" type="button">Cancel</button>
			#{/else}	
		#{/else}
</div>

</form>
<input type="hidden" id="dummy" />
<div id="detailForCertificateTransDetails" title="Certificate Management">
	#{include 'Certificates/detail_certificate_trans.html' /}
	<div class="buttons">
		#{if (((mode == "view"))||(confirming)) }
			<button id="cancelCertificateTransDetail">Close</button>				
		#{/if}
		#{else}
			<button id="addCertificateTransDetail" type="button">Save</button>
			<button id="cancelCertificateTransDetail" type="button">Cancel</button>
		#{/else}
		
	</div>
</div>